pipeline {
    agent any

    triggers {
    pollSCM("* * * * *")
    }

    stages {
        stage("Check versions"){
            steps{
               echo "Checking Docker versions"
               sh "docker --version"
            }
        }

        stage("Updating Docker Image ."){
            steps{
                dir("backend"){
                    echo "Updating Docker image"
                    sh "docker build -t smartbooks/matejkuka ."
                }
            }
        }
        
        stage("k6 performance testing"){
             steps{
                echo "Starting API container"
                sh "docker run -i -d --rm --name web-api -p 8081:80 smartbooks/matejkuka"
                dir("backend/tests"){
                    echo "Starting K6 performance testing"
                    sh "docker run --rm -i grafana/k6 run - <performance-test.js"
                    sh "docker run --rm -i grafana/k6 run - <performance-post-test.js"
                }
                echo "Stoping API container"
                sh "docker container stop web-api"
            }
        }
    }
}